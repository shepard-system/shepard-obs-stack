# configs/alertmanager/alertmanager.yaml â€” Shepherd alert routing
global:
  resolve_timeout: 5m

route:
  receiver: 'default'
  group_by: ['alertname', 'source']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    - match:
        severity: critical
      receiver: 'notify'
      repeat_interval: 1h

    - match:
        severity: warning
      receiver: 'notify'
      repeat_interval: 4h

receivers:
  - name: 'default'
    # Silently store alerts â€” visible in Alertmanager UI at :9093

  - name: 'notify'
    # â”€â”€ Telegram (native) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. Create bot: message @BotFather on Telegram â†’ /newbot
    # 2. Get chat_id: add bot to group, send message, then:
    #    curl -s https://api.telegram.org/bot<TOKEN>/getUpdates | jq '.result[0].message.chat.id'
    # 3. Uncomment below, fill in bot_token and chat_id, restart:
    #    docker compose restart alertmanager
    #
    # telegram_configs:
    #   - bot_token: 'YOUR_BOT_TOKEN'
    #     chat_id: YOUR_CHAT_ID
    #     send_resolved: true
    #     parse_mode: 'HTML'
    #     message: '{{ if eq .Status "firing" }}ðŸ”´ <b>{{ .Status | toUpper }}</b>{{ else }}âœ… <b>{{ .Status | toUpper }}</b>{{ end }}
    #       {{ range .Alerts }}
    #       <b>{{ .Labels.alertname }}</b> ({{ .Labels.severity }})
    #       {{ .Annotations.summary }}
    #       {{ if eq .Status "firing" }}<i>{{ .Annotations.description }}</i>{{ end }}
    #       {{ end }}'

    # â”€â”€ Slack (native) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. Create: https://api.slack.com/apps â†’ Incoming Webhooks â†’ Add to channel
    # 2. Uncomment below, replace URL, restart:
    #    docker compose restart alertmanager
    #
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/REPLACE_ME'
    #     channel: '#shepherd-alerts'
    #     send_resolved: true
    #     title: '{{ template "slack.default.title" . }}'
    #     text: >-
    #       {{ range .Alerts }}
    #       *{{ .Labels.alertname }}* ({{ .Labels.severity }})
    #       {{ .Annotations.summary }}
    #       {{ .Annotations.description }}
    #       {{ end }}

# Inhibit noisy alerts when the whole pipeline is down
inhibit_rules:
  - source_match:
      alertname: 'LokiDown'
    target_match_re:
      alertname: 'NoEventsReceived|HighTokenBurn'
    equal: ['cluster']
